{"componentChunkName":"component---src-templates-blog-post-js","path":"/get-started-with-web-wrokers/","result":{"data":{"site":{"siteMetadata":{"title":"itsopensource"}},"markdownRemark":{"id":"186e159a-0aba-55ef-9c5f-933d5cad57a8","excerpt":"Javascript is single threaded ie. all of the javascript code written is executed in a single thread. All the functions are executed sequentially. The next…","html":"<p>Javascript is single threaded ie. all of the javascript code written is executed in a single thread. All the functions are executed sequentially. The next function will be exceuted once the previous one has finished its execution. This sometimes leads to unresponsive UI.\nConsider this example,\nIn part 1 when we click on button 1, the UI freezes for 2 seconds as main thread is performing some CPU intensive operarions. Until this execution is finished the button 2 is not clickable at all.\n<img src=\"/cbe34008c8f618242f64c4ee52c55340/part1.gif\" alt=\"part1\"> The functionality of button 2 is independent from button 1 but still its unusable until button 1’s job is finished. This is a very common problem faced by javascript intensive web apps.</p>\n<p>Solution to this is <strong>Web Workers</strong> (<em>not Serviceworkers</em>)</p>\n<p>Web worker is a process that executes code independent of the main thread. Wokers do not have access to DOM and eventually do not have access to a lot of web APIs. They communicate with main thread script with <code class=\"language-text\">postMessage</code>.\nWorker should be home for all cpu intensive operations which can’t be done asynchronously otherwise. It would be an overkill to put a fetch operation in worker which is already async.</p>\n<p>For the given problem, we put the CPU intensive operations in a new file called <code class=\"language-text\">worker.js</code> .</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// worker.js</span>\n<span class=\"token keyword\">let</span> counter <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n<span class=\"token keyword\">let</span> delay <span class=\"token operator\">=</span> <span class=\"token number\">2000</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> time <span class=\"token operator\">=</span> Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> time <span class=\"token operator\">&lt;=</span> delay<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    counter <span class=\"token operator\">+=</span> <span class=\"token number\">1</span>\n<span class=\"token punctuation\">}</span>\nself<span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span>counter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br>\nThis will be executed as soon as the worker is created we can adjust this to be called only when required via postmessage.\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// worker.js</span>\nself<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"message\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">(</span><span class=\"token parameter\">event</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> data <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> counter <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n    <span class=\"token keyword\">let</span> time <span class=\"token operator\">=</span> Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> time <span class=\"token operator\">&lt;=</span> data<span class=\"token punctuation\">.</span>delay<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      counter <span class=\"token operator\">+=</span> <span class=\"token number\">1</span>\n    <span class=\"token punctuation\">}</span>\n    self<span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span>counter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span></code></pre></div>\n<br>\nNow heading to main script, we need to include the worker in the main script and send message to start computation.\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span><span class=\"token punctuation\">(</span>Worker<span class=\"token punctuation\">)</span> <span class=\"token operator\">!==</span> <span class=\"token string\">\"undefined\"</span><span class=\"token punctuation\">)</span>\n  worker <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Worker</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./worker.js\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br>\nTo start computing we just need to post message to worker\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">worker<span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> \n  data<span class=\"token punctuation\">:</span> data\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br>\nIn addition we add a listener to worker for recieving response from worker\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">worker<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onmessage</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">event</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> data <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// action with computed result</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br>\nOnce the operation is complete and we are sure we do not want to use this worker we need to terminate the worker. For this example we can terminate the worker once we recieve the response.\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">worker<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onmessage</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">event</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> data <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">;</span>\n  worker<span class=\"token punctuation\">.</span><span class=\"token function\">terminate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// action with computed result</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br>\nTo put together `script.js` should look like this\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// script.js</span>\n  <span class=\"token keyword\">let</span> data <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> delay<span class=\"token punctuation\">:</span> <span class=\"token number\">2000</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span><span class=\"token punctuation\">(</span>Worker<span class=\"token punctuation\">)</span> <span class=\"token operator\">!==</span> <span class=\"token string\">\"undefined\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> worker <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Worker</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./worker.js\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    worker<span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> data<span class=\"token punctuation\">:</span> data <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    worker<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onmessage</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">event</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">let</span> data <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">;</span>\n      worker<span class=\"token punctuation\">.</span><span class=\"token function\">terminate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token comment\">// action with computed result</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>The output looks something like this\n<img src=\"/28c9948a35f380a7f69e93b2622b57b2/part2.gif\" alt=\"part2\"></p>\n<p>All the CPU intensive operations are happening in worker while the UI is free and reponsive. The complete code can be found <a href=\"https://github.com/tsl143/itsopensource/tree/master/static/demos/webworkers\">here</a>.</p>\n<p>When it comes to loading time workers may not be evidently making your web app load fast, but it ensures the main thread is free and the UI is not frozen. One of the rule I follow is; All UI updates should be done in main thread and use workers for everything else.</p>","frontmatter":{"title":"Get started with web workers","tags":["webworkers","performance","javascript"],"date":"December 28, 2019","description":null,"author":"trishul"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/get-started-with-web-wrokers/","previous":{"fields":{"slug":"/offline-caching-with-serviceworkers/"},"frontmatter":{"author":"trishul","tags":["PWA","servcieworkers","javascript"],"title":"Offline caching with serviceworkers"}},"next":null}}}